# sqllog2db

[![Crates.io](https://img.shields.io/crates/v/dm-database-sqllog2db.svg)](https://crates.io/crates/dm-database-sqllog2db)
[![License: Apache 2.0](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![GitHub Release](https://img.shields.io/github/v/release/guangl/sqllog2db)](https://github.com/guangl/sqllog2db/releases)
[![Rust 1.56+](https://img.shields.io/badge/Rust-1.56%2B-orange.svg)](https://www.rust-lang.org/)

ä¸€ä¸ªè½»é‡ã€é«˜æ•ˆçš„ SQL æ—¥å¿—å¯¼å‡º CLI å·¥å…·ï¼šè§£æè¾¾æ¢¦æ•°æ®åº“ SQL æ—¥å¿—ï¼ˆæµå¼å¤„ç†ï¼‰ï¼Œå¯¼å‡ºåˆ° CSV æˆ–æ•°æ®åº“ï¼ˆSQLiteï¼‰ï¼Œå¹¶æä¾›å®Œå–„çš„é”™è¯¯è¿½è¸ªä¸ç»Ÿè®¡ã€‚

- **é«˜æ€§èƒ½**ï¼šå•çº¿ç¨‹æµå¼å¤„ç†ï¼Œ~397K æ¡/ç§’ååé‡ï¼ˆæ¨èé…ç½®ï¼‰
- **ç¨³å¥å¯é **ï¼šæ‰¹é‡å¯¼å‡º + é”™è¯¯èšåˆä¸æ‘˜è¦ï¼ˆerrors.summary.txtï¼‰
- **æ˜“äºä½¿ç”¨**ï¼šæ¸…æ™°çš„ TOML é…ç½®ï¼Œä¸‰æ­¥å®Œæˆå¯¼å‡ºä»»åŠ¡
- **ä½“ç§¯ä¼˜åŒ–**ï¼šé»˜è®¤ä»… CSV å¯¼å‡ºï¼Œå¯é€‰å¯ç”¨æ•°æ®åº“ç‰¹æ€§

> é€‚ç”¨åœºæ™¯ï¼šæ—¥å¿—å½’æ¡£ã€æ•°æ®åˆ†æé¢„å¤„ç†ã€åŸºäºæ—¥å¿—çš„é—®è´£/å®¡è®¡ã€å¼‚æ„ç³»ç»Ÿå¯¼å‡ºã€‚

---

## å¿«é€Ÿé“¾æ¥

- [Crates.io åŒ…é¡µé¢](https://crates.io/crates/dm-database-sqllog2db)
- [GitHub ä»“åº“](https://github.com/guangl/sqllog2db)
- [GitHub Releases](https://github.com/guangl/sqllog2db/releases)
- [CHANGELOG](./CHANGELOG.md)

---

## åŠŸèƒ½ç‰¹æ€§

- **æµå¼è§£æ SQL æ—¥å¿—**ï¼šå•çº¿ç¨‹é¡ºåºå¤„ç†ï¼Œæ€§èƒ½ä¼˜ç§€ä¸”å¯é¢„æµ‹ï¼ˆ~397K æ¡/ç§’ï¼‰
- **å•å¯¼å‡ºç›®æ ‡**ï¼ˆç®€åŒ–æ¶æ„ï¼‰ï¼š
  - CSVï¼ˆé»˜è®¤ç‰¹æ€§ï¼Œ8MB ç¼“å†²ä¼˜åŒ–ï¼‰
  - SQLiteï¼ˆå¯é€‰ç‰¹æ€§ï¼ŒWAL æ¨¡å¼ä¼˜åŒ–ï¼‰
- **æ™ºèƒ½æ‰¹å¤„ç†**ï¼šæ”¯æŒæŒ‰æ¡æ•°è¿›è¡Œæ‰¹é‡ flushï¼ˆæ¨è 10000 æ¡/æ‰¹ï¼‰
  - `batch_size > 0`: æ¯ N æ¡è®°å½• flush ä¸€æ¬¡
  - `batch_size = 0`: ç´¯ç§¯æ‰€æœ‰è®°å½•ï¼Œæœ€åä¸€æ¬¡æ€§ flush
- **å®Œå–„çš„é”™è¯¯è¿½è¸ª**ï¼š
  - è§£æå¤±è´¥é€æ¡è®°å½•åˆ° `errors.json`ï¼ˆJSON Lines æ ¼å¼ï¼‰
  - è‡ªåŠ¨ç”Ÿæˆ `errors.summary.txt`ï¼ŒåŒ…å«æ€»æ•°ã€åˆ†ç±»ä¸å­ç±»å‹ç»Ÿè®¡
- **æ—¥å¿—ç®¡ç†**ï¼šæ¯æ—¥æ»šåŠ¨ã€ä¿ç•™å¤©æ•°å¯é…ï¼ˆ1-365 å¤©ï¼‰
- **äºŒè¿›åˆ¶ä¼˜åŒ–**ï¼šLTO + strip + panic=abortï¼Œä½“ç§¯æœ€å°åŒ–

---

## å®‰è£…ä¸æ„å»º

ä½ å¯ä»¥é€‰æ‹©å¤šç§æ–¹å¼å®‰è£…æˆ–æ„å»ºã€‚

### ä» crates.io å®‰è£…ï¼ˆæ¨èï¼‰

```bash
cargo install dm-database-sqllog2db
```

### æœ¬åœ°æ„å»º

**æœ¬åœ°æ„å»ºï¼ˆå¼€å‘è€…æ¨èï¼‰**

```powershell
# åœ¨ä»“åº“æ ¹ç›®å½•
cargo build --release
```

**æœ¬åœ°å®‰è£…ï¼ˆæŠŠå¯æ‰§è¡Œå®‰è£…åˆ° Cargo bin ç›®å½•ï¼‰**

```powershell
cargo install --path .
```

### æ„å»ºæ•°æ®åº“å¯¼å‡ºæ”¯æŒï¼ˆå¯é€‰ï¼‰

å¯ç”¨ SQLite æ•°æ®åº“å¯¼å‡ºï¼š

```powershell
cargo build --release --features sqlite
```

> ğŸ’¡ æç¤ºï¼šé»˜è®¤ä»…åŒ…å« CSV å¯¼å‡ºï¼Œå¦‚éœ€æ•°æ®åº“å¯¼å‡ºè¯·å¯ç”¨ `sqlite` ç‰¹æ€§

---

## å¿«é€Ÿå¼€å§‹

1) ç”Ÿæˆé»˜è®¤é…ç½®ï¼ˆå¦‚å·²å­˜åœ¨å¯åŠ  `--force` è¦†ç›–ï¼‰ï¼š

```powershell
sqllog2db init -o config.toml --force
```

2) éªŒè¯é…ç½®ï¼š

```powershell
sqllog2db validate -c config.toml
```

3) è¿è¡Œå¯¼å‡ºï¼š

```powershell
sqllog2db run -c config.toml
```

---

## é…ç½®æ–‡ä»¶è¯´æ˜ï¼ˆconfig.tomlï¼‰

ä»¥ä¸‹ä¸º `sqllog2db init` ç”Ÿæˆçš„é»˜è®¤æ¨¡ç‰ˆï¼ˆå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰ï¼š

```toml
# SQL æ—¥å¿—å¯¼å‡ºå·¥å…·é…ç½®æ–‡ä»¶

[sqllog]
# SQL æ—¥å¿—è¾“å…¥ç›®å½•ï¼ˆå¯åŒ…å«å¤šä¸ªæ—¥å¿—æ–‡ä»¶ï¼‰
directory = "sqllogs"
# æ‰¹é‡æäº¤å¤§å° (0 è¡¨ç¤ºå…¨éƒ¨è§£æå®Œæˆåä¸€æ¬¡æ€§å†™å…¥; >0 è¡¨ç¤ºæ¯ N æ¡è®°å½•æ‰¹é‡å†™å…¥)
# æ¨èå€¼: 10000 (æœ€ä½³æ€§èƒ½)
batch_size = 10000

[error]
# è§£æé”™è¯¯æ—¥å¿—è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆJSON Lines æ ¼å¼ï¼‰
file = "errors.jsonl"

[logging]
# åº”ç”¨æ—¥å¿—è¾“å‡ºæ–‡ä»¶è·¯å¾„
file = "logs/sqllog2db.log"
# æ—¥å¿—çº§åˆ«: trace | debug | info | warn | error
level = "info"
# æ—¥å¿—ä¿ç•™å¤©æ•° (1-365) - ç”¨äºæ»šåŠ¨æ–‡ä»¶æœ€å¤§ä¿ç•™æ•°é‡
retention_days = 7

[features]
# æ˜¯å¦æ›¿æ¢ SQL ä¸­çš„å‚æ•°å ä½ç¬¦ï¼ˆå¦‚ ? -> å®é™…å€¼ï¼‰
replace_sql_parameters = false
# æ˜¯å¦å¯ç”¨åˆ†æ•£å¯¼å‡ºï¼ˆæŒ‰æ—¥æœŸæˆ–å…¶ä»–ç»´åº¦æ‹†åˆ†è¾“å‡ºæ–‡ä»¶ï¼‰
scatter = false

# ===================== å¯¼å‡ºå™¨é…ç½® =====================
# åªæ”¯æŒå•ä¸ªå¯¼å‡ºå™¨ï¼ŒæŒ‰ä¼˜å…ˆçº§é€‰æ‹©ï¼šCSV > Database

# CSV å¯¼å‡ºï¼ˆé»˜è®¤ï¼‰
[exporter.csv]
file = "export/sqllog2db.csv"
overwrite = true

# æ•°æ®åº“å¯¼å‡ºç¤ºä¾‹ï¼ˆéœ€ç¼–è¯‘æ—¶å¯ç”¨ sqlite ç‰¹æ€§ï¼‰
# [exporter.database]
# database_type = "sqlite"
# file = "export/sqllog2db.sqlite"
# overwrite = true
# table_name = "sqllog"
```

**é…ç½®è¯´æ˜ï¼š**
- **å­—æ®µå‘½åæ›´æ–°ï¼ˆv0.1.2ï¼‰**ï¼š
  - `sqllog.path` â†’ `sqllog.directory` (è¾“å…¥ç›®å½•)
  - æ‰€æœ‰ `path` å­—æ®µ â†’ `file` (è¾“å‡ºæ–‡ä»¶)
  - æ—§å­—æ®µåä»ç„¶å…¼å®¹ï¼Œä½†å»ºè®®ä½¿ç”¨æ–°åç§°
- åªæ”¯æŒå•ä¸ªå¯¼å‡ºå™¨ï¼Œå¦‚é…ç½®å¤šä¸ªå°†æŒ‰ä¼˜å…ˆçº§é€‰æ‹©ç¬¬ä¸€ä¸ª
- `batch_size = 10000` æä¾›æœ€ä½³æ€§èƒ½
- `logging.retention_days` å¿…é¡»åœ¨ 1-365 ä¹‹é—´

> **æ³¨æ„**ï¼šä» v0.1.1 å¼€å§‹ï¼Œä»…æ”¯æŒå•ä¸ªå¯¼å‡ºå™¨ï¼ˆç®€åŒ–æ¶æ„ï¼‰ï¼Œé…ç½®æ ¼å¼ä¸º `[exporter.csv]` æˆ– `[exporter.database]`ã€‚

## å¯¼å‡ºä¸é”™è¯¯æ—¥å¿—

- **å¯¼å‡ºç»Ÿè®¡**ï¼šå¯¼å‡ºå™¨ä¼šè¾“å‡ºæˆåŠŸ/å¤±è´¥æ¡æ•°ä¸æ‰¹é‡ flush æ¬¡æ•°
- **é”™è¯¯æ—¥å¿—**ï¼š
  - `errors.json` ç”¨äºè®°å½•é€æ¡è§£æå¤±è´¥çš„è¯¦ç»†ä¿¡æ¯ï¼ˆJSON Lines æ ¼å¼ï¼‰
  - `errors.json.summary.txt` è‡ªåŠ¨ç”Ÿæˆçš„æ‘˜è¦æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
    - `total`: é”™è¯¯æ€»æ•°
    - `by_category`: å„é”™è¯¯å¤§ç±»è®¡æ•°ï¼ˆConfig/File/Database/Parse/Exportï¼‰
    - `parse_variants`: è§£æé”™è¯¯å­ç±»å‹åˆ†å¸ƒ

> å¦‚æœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œ`errors.summary.txt` ä¾ç„¶ä¼šç”Ÿæˆï¼ˆç©ºè®¡æ•°ï¼‰ï¼Œä¾¿äºè‡ªåŠ¨åŒ–æ±‡æ€»ã€‚

---

## åŠŸèƒ½ç‰¹æ€§å¼€å…³

- **é»˜è®¤å¯ç”¨**ï¼š`csv`ï¼ˆCSV æ–‡ä»¶å¯¼å‡ºï¼‰
- **å¯é€‰å¯ç”¨**ï¼š`sqlite`ï¼ˆSQLite æ•°æ®åº“å¯¼å‡ºï¼‰

ç¼–è¯‘ç¤ºä¾‹ï¼š

```powershell
# é»˜è®¤æ„å»ºï¼ˆä»… CSVï¼‰
cargo build --release

# å¯ç”¨ SQLite æ•°æ®åº“å¯¼å‡º
cargo build --release --features sqlite
```

> ğŸ’¡ **ä½“ç§¯ä¼˜åŒ–æç¤º**ï¼šå¦‚æœä»…éœ€ CSV å¯¼å‡ºï¼Œä½¿ç”¨é»˜è®¤æ„å»ºå¯æ˜¾è‘—å‡å°äºŒè¿›åˆ¶ä½“ç§¯ã€‚

---

## å¼€å‘ä¸æµ‹è¯•

è¿è¡Œå…¨éƒ¨æµ‹è¯•ï¼š

```powershell
cargo test
```

è¿è¡Œå¸¦ SQLite ç‰¹æ€§çš„æµ‹è¯•ï¼š

```powershell
cargo test --features sqlite
```

è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š

```powershell
cargo bench
```

---

## æ€§èƒ½ä¸ä½“ç§¯

### æ€§èƒ½æµ‹è¯•ç»“æœ

**æµ‹è¯•ç¯å¢ƒ**: ~1.1GB SQL æ—¥å¿—æ–‡ä»¶ï¼Œçº¦ 320 ä¸‡æ¡è®°å½•ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰

| é…ç½® | å¹³å‡ç”¨æ—¶ | ååé‡ | ç›¸å¯¹æ€§èƒ½ |
|------|---------|--------|---------|
| **batch_size=10000 (æ¨è)** | **8.11s** | **~397K æ¡/ç§’** | 100% (æœ€å¿«) |
| batch_size=50000 | 8.43s | ~382K æ¡/ç§’ | 104% |
| batch_size=1000 | 8.67s | ~371K æ¡/ç§’ | 107% |
| batch_size=0 (å…¨éƒ¨ç´¯ç§¯) | 9.15s | ~352K æ¡/ç§’ | 113% |

**ç»“è®º**: é»˜è®¤é…ç½® `batch_size=10000` æä¾›æœ€ä½³æ€§èƒ½ï¼Œåœ¨ I/O æ•ˆç‡å’Œå†…å­˜å ç”¨ä¹‹é—´è¾¾åˆ°æœ€ä½³å¹³è¡¡ã€‚

**æ€§èƒ½ç“¶é¢ˆåˆ†æ**ï¼ˆNVMe SSD æµ‹è¯•ï¼‰ï¼š
- è§£æï¼š5.62s (69%) - ä¸»è¦ç“¶é¢ˆ
- CSV æ ¼å¼åŒ–ï¼š1.51s (19%)
- æ–‡ä»¶å†™å…¥ï¼š0.22s (3%)
- å…¶ä»–å¼€é”€ï¼š0.76s (9%)

è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼š
```bash
cargo bench --bench performance
```

### äºŒè¿›åˆ¶ä½“ç§¯

- Release æ„å»ºå·²å¯ç”¨ï¼š`opt-level = "z"`, `lto = true`, `codegen-units = 1`, `strip = true`, `panic = "abort"`
- å»ºè®®ä»…å¯ç”¨æ‰€éœ€ç‰¹æ€§ä»¥è·å¾—æ›´å°äºŒè¿›åˆ¶ä½“ç§¯
- å•å¯¼å‡ºå™¨æ¨¡å¼ç§»é™¤äº†å¤šçº¿ç¨‹å¼€é”€ï¼ˆå·²ç§»é™¤ `crossbeam`ã€`rayon` ä¾èµ–ï¼‰

---

## æ•…éšœæ’æŸ¥

- **ç¨‹åºæ— æ³•å¯åŠ¨ / é…ç½®è§£æå¤±è´¥**ï¼š
  - ä½¿ç”¨ `sqllog2db validate -c config.toml` æ£€æŸ¥é…ç½®
  - ç¡®ä¿ä½¿ç”¨æ–°çš„å­—æ®µåç§°ï¼ˆv0.1.2+ï¼‰ï¼š`directory` å’Œ `file` è€Œé `path`
  - ç¡®ä¿ `logging.file` ä¸ºåˆæ³•çš„æ–‡ä»¶è·¯å¾„ï¼Œå…¶çˆ¶ç›®å½•å¯åˆ›å»º
- **æœªç”Ÿæˆå¯¼å‡ºæ–‡ä»¶**ï¼š
  - ç¡®è®¤ `sqllog.directory` ä¸‹æ˜¯å¦å­˜åœ¨ `.log` æ–‡ä»¶
  - æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸ `errors.json` å®šä½é—®é¢˜
  - æ£€æŸ¥æ˜¯å¦é…ç½®äº†å¯¼å‡ºå™¨ï¼ˆè‡³å°‘é…ç½®ä¸€ä¸ªï¼šCSV æˆ– Databaseï¼‰
- **æ•°æ®åº“å¯¼å‡ºå¤±è´¥**ï¼š
  - æ£€æŸ¥ `database_type` æ˜¯å¦ä¸º `sqlite`
  - ç¡®ä¿ç¼–è¯‘æ—¶å·²å¯ç”¨ `sqlite` ç‰¹æ€§
  - éªŒè¯æ•°æ®åº“æ–‡ä»¶è·¯å¾„åŠçˆ¶ç›®å½•å¯å†™
- **é…ç½®è¿ç§»é—®é¢˜**ï¼š
  - v0.1.2 æ›´æ–°äº†å­—æ®µå‘½åï¼Œä½†ä¿æŒå‘åå…¼å®¹
  - æ—§é…ç½®æ–‡ä»¶ä»å¯ä½¿ç”¨ï¼Œä½†å»ºè®®æ›´æ–°åˆ°æ–°å­—æ®µå

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache-2.0 è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](./LICENSE) æ–‡ä»¶ã€‚

---

## è‡´è°¢

æ ¸å¿ƒä¾èµ–ï¼š
- æ—¥å¿—è§£æï¼š[dm-database-parser-sqllog](https://crates.io/crates/dm-database-parser-sqllog)
- CLI æ¡†æ¶ï¼š[clap](https://crates.io/crates/clap)
- æ—¥å¿—ç³»ç»Ÿï¼š[tracing](https://crates.io/crates/tracing) + [tracing-subscriber](https://crates.io/crates/tracing-subscriber)
- åºåˆ—åŒ–ï¼š[serde](https://crates.io/crates/serde) + [serde_json](https://crates.io/crates/serde_json)
- æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰ï¼š[rusqlite](https://crates.io/crates/rusqlite)

æ„Ÿè°¢ Rust ç¤¾åŒºæä¾›çš„ä¼˜ç§€ç”Ÿæ€ç³»ç»Ÿã€‚
