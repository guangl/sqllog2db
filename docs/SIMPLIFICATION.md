# 架构简化说明

## 概述

本文档说明了 sqllog2db 从多导出器并发架构简化为单导出器顺序处理架构的原因和影响。

## 变更内容

### 移除的功能

1. **多导出器并发支持**
   - 之前：支持同时配置多个导出器（CSV、JSONL、Database），每个导出器在独立线程中运行
   - 现在：只支持单个导出器，按优先级选择第一个配置的导出器

2. **多线程并发处理**
   - 之前：解析线程通过 channel 将记录分发给多个导出器线程
   - 现在：单线程顺序处理：解析 → 导出

3. **依赖项**
   - 移除 `crossbeam` - 不再需要多生产者多消费者通道
   - 移除 `rayon` - 不再需要并行迭代器

### 保留的功能

- ✅ 流式解析（逐条处理，低内存占用）
- ✅ 批量导出（batch_size 配置）
- ✅ 错误日志记录
- ✅ 多种导出格式（CSV、JSONL、Database）
- ✅ 所有 CLI 命令（init、validate、run）

## 简化原因

### 1. 性能测试结果

通过多次性能测试发现：

```
数据集：~1.1GB SQL 日志，约 320 万条记录

单线程单导出器：     ~5.75s
单线程双导出器：     ~6.12s
多线程解析（2线程）：~8.29s
多线程解析（4线程）：更慢
```

**结论**：多线程并发不仅没有提升性能，反而引入额外开销。

### 2. 瓶颈分析

真正的性能瓶颈在于：

- **磁盘 I/O**：机械硬盘的顺序读取带宽有限
- **导出写入**：文件写入是串行操作
- **解析速度**：解析本身很快，不是瓶颈

多线程带来的负面影响：

- Channel 通信开销
- Arc 指针克隆
- 线程切换开销
- 缓存失效
- 随机磁盘访问（多线程同时读取不同文件）

### 3. 使用场景分析

实际使用中，大多数用户只需要一个导出目标：

- 导出到 CSV 进行分析
- 或导出到数据库进行查询
- 很少需要同时导出多个格式

### 4. 代码复杂度

- 单线程模式代码简单、易理解、易维护
- 多线程模式增加了大量同步和错误处理代码
- Bug 更容易定位和修复

## 导出器优先级

当配置文件中包含多个导出器时，按以下优先级选择：

1. **CSV** - 文件导出器，最常用
2. **JSONL** - 文件导出器，结构化数据
3. **Database** - 数据库导出器（SQLite、DuckDB 等）

系统会在启动时显示警告信息：

```
警告: 配置了 3 个导出器，但只支持单个导出器。
将按优先级使用第一个导出器：CSV > JSONL > Database
```

## 迁移指南

### 如果你之前配置了多个导出器

**之前的配置（不再支持同时使用）：**

```toml
[[exporter.csv]]
path = "export/output.csv"

[[exporter.jsonl]]
path = "export/output.jsonl"
```

**迁移方案 1：运行多次**

```bash
# 第一次运行：导出 CSV
sqllog2db run --config config-csv.toml

# 第二次运行：导出 JSONL
sqllog2db run --config config-jsonl.toml
```

**迁移方案 2：只保留一个导出器**

根据你的主要需求，只配置一个导出器：

```toml
# 只配置 CSV 导出
[[exporter.csv]]
path = "export/output.csv"
overwrite = true
```

### 性能优化建议

1. **调整 batch_size**
   - 默认值 `10000` 适合大多数场景
   - 内存充足时可以增加到 `50000` 或更高
   - 内存受限时可以减小到 `1000`

2. **使用 SSD**
   - 在 SSD 上运行可获得更好的 I/O 性能
   - 机械硬盘建议使用顺序读取

3. **导出到数据库**
   - SQLite/DuckDB 导出时，使用批量插入
   - 确保数据库文件在快速存储设备上

## 未来考虑

如果未来发现确实需要多导出器支持，可以考虑以下方案：

1. **外部工具链**：使用 shell 脚本多次运行
2. **管道模式**：读取 JSONL 并导出到多个目标
3. **条件重新实现**：仅在高性能存储（NVMe、网络存储）和大量小文件场景

## 总结

这次简化带来的好处：

- ✅ 代码更简单、更易维护
- ✅ 二进制体积更小（移除依赖）
- ✅ 性能更可预测
- ✅ 更少的 Bug 可能性
- ✅ 适合绝大多数使用场景

对于需要多个导出目标的场景，通过多次运行或脚本化处理完全可以满足需求。